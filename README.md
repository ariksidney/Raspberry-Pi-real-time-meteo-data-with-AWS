## What you need ##

* Raspberry Pi 2 Model B

* SensHat for Raspberry Pi

* AWS Account

#### Used Python Libraries ####

* paho mqtt client

* sense_hat


AWS IoT documentation: [AWS IoT](http://docs.aws.amazon.com/iot/latest/developerguide/iot-quickstart.html)

To connect our "Thing" to the IoT Service from Amazon we need to do a few steps.

1. Create the Thing

2. Create Policy and IAM roles

3. Create Lambda Function

4. Create IoT Rule

5. Create a secure Communication

6. Test it

7. amCharts integration

## Create the Thing ##
Head over to the AWS IoT Dashboard and click on "Create a resource" and then "Create a thing". Name the thing "sensorPi" for example.

## Create Roles and Policy ##

* The following steps are documented here: [Configure and Test Rules](http://docs.aws.amazon.com/iot/latest/developerguide/config-and-test-rules.html)

* Create an IAM role for IoT

```JSON
{
"Version": "2012-10-17",
"Statement": [{
      "Sid": "",
      "Effect": "Allow",
      "Principal": {
            "Service": "iot.amazonaws.com"
       },
      "Action": "sts:AssumeRole"
  }]
}
```
And create it with: 

```bash
aws iam create-role --role-name iot-sensorPi-role --assume-role-policy-document file://path-to-file
```

* Grant permission to Role

```JSON
{
    "Version": "2012-10-17",    
    "Statement": [{
        "Effect": "Allow",
        "Action": [ "dynamodb:*", "lambda:InvokeFunction"], 
        "Resource": ["*"]
    }]
}
```
Create policy with:

```bash
aws iam create-policy --policy-name iot-sensorPi-policy --policy-document file://IAM-policy-document-file-path
```
And set policy to role with:

```bash
aws iam attach-role-policy --role-name iot-sensorPi-role --policy-arn "policy-ARN"
```

## Create Lambda Function ##

* Open the AWS Lambda Dashboard in a new tab and create a new function.

* Select the hello-world blueprint 

* Give a name to the function (i.E sensorPi_iot_function) and change the runtime to Python2.7. Select the lambda basic execution as role (more on that later) and leave the other parameters untouched.

* Copy the code from lambda_iot_function.py (can be found in this git repo) to the lambda function and save it. 

* Open the lambda basic execution role in the AWS IAM Dashboard and add these three inline policies:

To access the dynamoDB table from Lambda:

```JSON
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Stmt1453732755000",
            "Effect": "Allow",
            "Action": [
                "dynamodb:BatchWriteItem",
                "dynamodb:PutItem",
                "dynamodb:UpdateItem"
            ],
            "Resource": [
                "Table ARN"
            ]
        }
    ]
}
```
For the Lambda Logs:

```JSON
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
            ],
            "Resource": "arn:aws:logs:*:*:*"
        }
    ]
}
```
And to access the desired S3 bucket:

```JSON
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Stmt1453737146000",
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:PutObjectAcl",
                "s3:GetObject"
            ],
            "Resource": [
                "S3 bucket ARN"
            ]
        }
    ]
}
```



## Create a Trigger Rule for Lambda ##

* To create a Rule to trigger our created Lambda Function, copy the following json to the Raspberry Pi.

```JSON
{
    "sql": "SELECT * FROM 'sensorpi/meteo'",
    "ruleDisabled": false,
    "actions": [{
        "lambda": {
            "functionArn": "lambda ARN"
        }
    }]
}
```

* Create the rule by executing: 

```bash
aws iot create-topic-rule --rule-name invokeLambdaForSensorPi --topic-rule-payload file://path-to-file/LambdaRule
```

## Create a secure communication between the Raspi and AWS IoT ##

* To create the secure connection we need certificates generated by AWS IoT. To generate these, execute the following command on the Raspberry Pi:

```bash
aws iot create-keys-and-certificate --set-as-active --certificate-pem-outfile sensorPi-cert.pem --public-key-outfile sensorPi-publicKey.pem --private-key-outfile sensorPi-privateKey.pem
```

* Create an IoT Policy

```JSON
{
    "Version": "2012-10-17", 
    "Statement": [{
        "Effect": "Allow",
        "Action":["iot:*"],
        "Resource": ["*"]
    }]
}
```

and let it run with:

```bash
aws iot create-policy --policy-name "SensorPiPublishToTopic" --policy-document file://test.json
```

And attach the policy to the certificate:

```bash
aws iot attach-principal-policy --principal "certificate ARN" --policy-name "SensorPiPublishToTopic"
```

* Attach certificate to the thing

Just execute the following command on the thing:

```bash
aws iot attach-thing-principal --thing-name "sensorPi" --principal "certificate ARN"
```

* You also need a root certificate. Save the one below to the same place as the certifcates above and name it rootCA.crt. This one is issued by  symantec and accepted by AWS:

```
-----BEGIN CERTIFICATE-----
MIIE0zCCA7ugAwIBAgIQGNrRniZ96LtKIVjNzGs7SjANBgkqhkiG9w0BAQUFADCB
yjELMAkGA1UEBhMCVVMxFzAVBgNVBAoTDlZlcmlTaWduLCBJbmMuMR8wHQYDVQQL
ExZWZXJpU2lnbiBUcnVzdCBOZXR3b3JrMTowOAYDVQQLEzEoYykgMjAwNiBWZXJp
U2lnbiwgSW5jLiAtIEZvciBhdXRob3JpemVkIHVzZSBvbmx5MUUwQwYDVQQDEzxW
ZXJpU2lnbiBDbGFzcyAzIFB1YmxpYyBQcmltYXJ5IENlcnRpZmljYXRpb24gQXV0
aG9yaXR5IC0gRzUwHhcNMDYxMTA4MDAwMDAwWhcNMzYwNzE2MjM1OTU5WjCByjEL
MAkGA1UEBhMCVVMxFzAVBgNVBAoTDlZlcmlTaWduLCBJbmMuMR8wHQYDVQQLExZW
ZXJpU2lnbiBUcnVzdCBOZXR3b3JrMTowOAYDVQQLEzEoYykgMjAwNiBWZXJpU2ln
biwgSW5jLiAtIEZvciBhdXRob3JpemVkIHVzZSBvbmx5MUUwQwYDVQQDEzxWZXJp
U2lnbiBDbGFzcyAzIFB1YmxpYyBQcmltYXJ5IENlcnRpZmljYXRpb24gQXV0aG9y
aXR5IC0gRzUwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCvJAgIKXo1
nmAMqudLO07cfLw8RRy7K+D+KQL5VwijZIUVJ/XxrcgxiV0i6CqqpkKzj/i5Vbex
t0uz/o9+B1fs70PbZmIVYc9gDaTY3vjgw2IIPVQT60nKWVSFJuUrjxuf6/WhkcIz
SdhDY2pSS9KP6HBRTdGJaXvHcPaz3BJ023tdS1bTlr8Vd6Gw9KIl8q8ckmcY5fQG
BO+QueQA5N06tRn/Arr0PO7gi+s3i+z016zy9vA9r911kTMZHRxAy3QkGSGT2RT+
rCpSx4/VBEnkjWNHiDxpg8v+R70rfk/Fla4OndTRQ8Bnc+MUCH7lP59zuDMKz10/
NIeWiu5T6CUVAgMBAAGjgbIwga8wDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8E
BAMCAQYwbQYIKwYBBQUHAQwEYTBfoV2gWzBZMFcwVRYJaW1hZ2UvZ2lmMCEwHzAH
BgUrDgMCGgQUj+XTGoasjY5rw8+AatRIGCx7GS4wJRYjaHR0cDovL2xvZ28udmVy
aXNpZ24uY29tL3ZzbG9nby5naWYwHQYDVR0OBBYEFH/TZafC3ey78DAJ80M5+gKv
MzEzMA0GCSqGSIb3DQEBBQUAA4IBAQCTJEowX2LP2BqYLz3q3JktvXf2pXkiOOzE
p6B4Eq1iDkVwZMXnl2YtmAl+X6/WzChl8gGqCBpH3vn5fJJaCGkgDdk+bW48DW7Y
5gaRQBi5+MHt39tBquCWIMnNZBU4gcmU7qKEKQsTb47bDN0lAtukixlE0kF6BWlK
WE9gyn6CagsCqiUXObXbf+eEZSqVir2G3l6BFoMtEMze/aiCKm0oHw0LxOXnGiYZ
4fQRbxC1lfznQgUy286dUV4otp6F01vvpX1FQHKOtw5rDgb7MzVIcbidJ4vEZV8N
hnacRHr2lVz2XTIIM6RUthg/aFzyQkqFOFSDX9HoLPKsEdao7WNq
-----END CERTIFICATE-----

```

## Test it ##

* Copy iot_send_to_lambda.py over to the Raspberry Pi.

* Edit the paths to the certificates

* Change the Aws IoT endpoint. To get your endpoint execute this command on your Thing:

```bash
aws iot describe-endpoint
```

* Change the topic on which to publish.

* Let it run and check your DynamoDB table and S3 bucket.

## amCharts integration ##

* Just download the chart.html and change the two URLs to the one from your S3 json file.
